/*!
 * @summary JSON Schema driven Form written in pure JavaScript as a Web Component
 * @author John Doherty <www.johndoherty.info>
 * @copyright John Doherty 2017
 * @license MIT
 */
!function(t,e,r){"use strict";function i(){if(this.schema){var t=this,e=this.schema.properties,r=v(this.schema),i=1,n=null;this.form=this.querySelector("form"),this.form||(this.form=m(this,"form",{action:"",method:"post",novalidate:"novalidate"}),this.form.onsubmit=function(e){d(e),l.call(t)}),this.form.innerHTML="",r=r.filter(function(t){return"links"!==t&&-1===t.indexOf("$")&&e.hasOwnProperty(t)});for(var a=0;a<r.length;a++){var u=r[a],o=e[u];n=m(null,"label",{for:u,class:"pure-form-label"}),o.format&&n.setAttribute("data-format",o.format),o.type&&n.setAttribute("data-type",o.type),o.required&&n.setAttribute("data-required",!0),m(n,"span",{class:"pure-form-label-text"},o.title||u);var c=h.call(this,u,o);if(!c)throw new Error("Failed to convert schema item to html element (key:"+u+")");var f="hidden"===c.type;this.readonly?c.setAttribute("readonly","true"):f||(1===i&&c.setAttribute("autofocus","true"),c.onblur=function(){t.validateField(this.id,this.value)}),f?this.form.appendChild(c):(n.appendChild(c),o.description&&o.description.length>this.placeholderMaxLength&&m(n,"span",{class:"pure-form-item-description"},o.description||""),this.form.appendChild(n)),i++}this.readonly&&Array.prototype.slice.call(this.form.querySelectorAll("input,select,textarea")).forEach(function(t){t.setAttribute("disabled","true")}),s.call(this)}}function n(){var t=this.querySelector(".pure-form-title");t?t.innerHTML=this.title:(t=m(null,"div",{class:"pure-form-title"},this.title),this.insertBefore(t,this.form))}function a(){var t=this.querySelector(".pure-form-description");t?t.innerHTML=this.description:(t=m(null,"div",{class:"pure-form-description"},this.description),this.insertBefore(t,this.form))}function s(){var t=this;if(this.form&&this.buttons.length>0){var e=this.form.querySelector(".pure-form-buttons")||m(this.form,"div",{class:"pure-form-buttons"});e.innerHTML="";for(var r=0,i=this.buttons.length;r<i;r++)m(e,"input",{type:"submit",value:this.buttons[r].trim(),class:"pure-form-button"}).onclick=function(e){d(e),t.onbuttonclick.call(t,this.value)}}}function u(){var t=(this.schema||{}).properties,e={};for(var r in t)if("links"!==r&&-1===r.indexOf("$")&&t.hasOwnProperty(r)){var i=t[r];if(t[r].readonly)e[r]=this.value&&this.value[r]||i.required&&i.default||void 0;else{var n=this.querySelector('[name="'+r+'"]');if(n)switch(i.type){case"array":"textarea"===i.items.format?e[r]=""!=n.value?n.value.split("\n"):[]:"uri"===i.items.format?e[r]=n.data:(Array.isArray(n.value),e[r]=n.value);break;case"boolean":e[r]=n.checked;break;case"integer":e[r]=n.value?parseInt(n.value):"";break;case"number":e[r]=n.value?parseFloat(n.value):"";break;default:e[r]=(n.value||"").trim()}i.required||""!==e[r]||delete e[r]}}return e}function o(){var t=this.schema.properties,e={};for(var r in t)if("links"!==r&&-1===r.indexOf("$")&&!t[r].readonly&&t.hasOwnProperty(r)){var i=t[r],n=this.querySelector('[name="'+r+'"]');if(n)switch(i.type){case"array":"uri"===i.items.format||"object"===i.items.type?e[r]=n.data:e[r]=n.value;break;case"boolean":e[r]=n.checked;break;default:e[r]=(n.value||"").trim()}}return e}function l(){var t=this,e=this.getAttribute("create-url")||"",r=this.getAttribute("update-url")||"",i=u.call(this);if(t.clearValidationErrors(),!t.isValid(i))return!1;""!==r?fetch(r,{method:"PUT",body:i,headers:new Headers({"Content-Type":"application/json"})}).then(function(t){return t.json()}).then(function(e){var r=y((e||{}).links,"rel","next",!0);t.onupdate.call(t,e,r)&&r&&(t.src=r.href)}):""!==e?fetch(e,{method:"POST",body:i,headers:new Headers({"Content-Type":"application/json"})}).then(function(t){return t.json()}).then(function(e){var r=y((e||{}).links,"rel","next",!0);t.oncreate.call(t,e,r)&&r&&(t.src=r.href)}):t.onsave.call(t,i)}function c(t){t=t||this._value;for(var e in t)if("links"!==e&&-1===e.indexOf("$")&&t.hasOwnProperty(e)){var r=this.querySelector('[name="'+e+'"]'),i=void 0!==t[e]?t[e]:"";if(!r)continue;g(r,i)}this.onpopulatecomplete&&this.onpopulatecomplete.call(this)}function h(t,e){var r=null,i=e.items&&e.items.type||e.type,n=(e.items&&e.items.format||e.format||"").toLowerCase();switch(i){case"number":case"integer":if(Number.isInteger(e.minimum)&&Number.isInteger(e.maximum)){m(r=m(null,"select",{name:t,id:t}),"option",{value:""});for(var a=e.minimum;a<=e.maximum;a++)m(r,"option",{value:a},a)}else r=m(null,"input",{name:t,id:t,type:"number",value:""});break;default:if(Array.isArray(e.enum))m(r=m(null,"select",{name:t,id:t}),"option",{value:""}),e.enum.forEach(function(t){m(r,"option",{value:t},t)});else switch(n.toLowerCase()){case"url":case"uri":r=m(null,"input",{name:t,id:t,type:"url",value:""});break;case"textarea":r=m(null,"textarea",{name:t,id:t,value:"",rows:3});break;case"date":r=m(null,"input",{name:t,id:t,type:"date",value:""});break;case"email":r=m(null,"input",{name:t,id:t,type:"email",pattern:x.email,value:""});break;default:r=m(null,"input",{name:t,id:t,type:"text",value:""})}}return r&&(r.setAttribute("autocomplete","off"),e.readonly&&r.setAttribute("readonly","readonly"),e.required&&r.setAttribute("required","required"),e.pattern&&r.setAttribute("pattern",e.pattern),e.min&&r.setAttribute("min",e.min),e.max&&r.setAttribute("max",e.max),e.minLength&&r.setAttribute("minlength",e.minLength),e.maxLength&&r.setAttribute("maxlength",e.maxLength),e.minItems&&r.setAttribute("min-items",e.minItems),e.maxItems&&r.setAttribute("max-items",e.maxItems),e.description&&e.description.length<this.placeholderMaxLength&&r.setAttribute("placeholder",e.description||"")),r}function m(t,e,i,n,a){var s=r.createElement(e),u="",o=e.indexOf("-")>0;if(i)for(u in i)"class"===u?s.className=i[u]:"id"===u?s.id=i[u]:"name"===u?s.setAttribute(u,i[u]):o||u in s?s[u]=i[u]:s.setAttribute(u,i[u]);return void 0!==n&&s.appendChild(r.createTextNode(n)),void 0!==a&&(s.innerHTML="",f(a,s)),t&&t.appendChild(s),s}function f(t,e){e=e||r.createDocumentFragment();var i=null,n=r.createElement("div");n.innerHTML=t;for(var a=n.getElementsByTagName("script"),s=a.length-1;s>=0;s--)a[s].parentElement.removeChild(a[s]);for(;i=n.firstChild;)e.appendChild(i);return e}function d(t){(t=t||e.event)&&(t.returnValue=!1,t.cancelBubble=!0,"function"==typeof t.preventDefault&&t.preventDefault(),"function"==typeof t.stopPropagation&&t.stopPropagation())}function p(t,e,r){var i=b(t,e,!0),n=(r+"").length;if(i){if(r&&"string"===i.type&&"email"===i.format&&!A(r.toString(),x.email))return"Invalid email address";if(i.required&&(!r||Array.isArray(r)&&r.length<=0))return"This field must have a value";if(i.minItems&&Array.isArray(r)&&r.length<i.minItems)return"Please select at least "+i.minItems+" item(s)";if(i.maxItems&&Array.isArray(r)&&r.length>i.maxItems)return"Please select a maximum of "+i.maxItems+" item(s)";if(r&&i.pattern&&!A(r.toString(),i.pattern))return"The value is not in the expected format";if(r&&i.minimum&&parseInt(r,10)<i.minimum)return"The value must not be lower than "+i.minimum;if(r&&i.maximum&&parseInt(r,10)>i.maximum)return"The value must not be higher than "+i.maximum;if(r&&i.minLength&&n<i.minLength)return"The value must have a minimum of "+i.minLength+" character(s)"}return null}function b(t,e,r){if(void 0===t)return!1;(r=void 0!==t.$schema||r)&&(t.properties&&e.indexOf(".properties")<=-1?e="properties."+e:t.items&&e.indexOf(".items")<=-1&&(e="items."+e));var i=e.indexOf(".");return i>-1?(t=t[e.substring(0,i)],e=e.substr(i+1),b(t,e,r)):t[e]}function v(t){t=t.properties||t;var e=Object.keys(t);return e.sort(function(e,r){return(t[e].id?parseInt(t[e].id.replace(/[^0-9]+/gi,"")||"0"):0)-(t[r].id?parseInt(t[r].id.replace(/[^0-9]+/gi,"")||"0"):0)}),e}function g(t,e){var r=t?t.tagName.toLowerCase():"",i=t.type||"";switch(r){case"input":"checkbox"===i?e?t.setAttribute("checked",!0===e):t.removeAttribute("checked"):t.value=e;break;case"textarea":t.value=e.join?e.join("\n"):e;break;default:t.value=e}}function y(t,e,r,i){for(var n=[],a=0,s=(t=t||[]).length;a<s;a++)if(t[a][e]==r){if(i)return t[a];n.push(t[a])}return i?null:n}function A(t,e){return(e.constructor!==RegExp?new RegExp(e,"g"):e).test(t)}var x={email:"^[a-zA-Z0-9.-_]{1,}@[a-zA-Z.-]{2,}[.]{1}[a-zA-Z]{2,}$"},k=Object.create(t,{src:{get:function(){return this.getAttribute("src")||""},set:function(t){this.setAttribute("src",t)}},schema:{get:function(){return this._schema||null},set:function(t){this._schema=t,this.title=this._schema.title,this.description=this._schema.description;var e=y(this._schema.links,"rel","self",!0);e&&(this.updateUrl=e.href,this.buttons+=e.title||"Update");var r=y(this._schema.links,"rel","create",!0);e&&(this.createUrl=r.href,this.buttons+=r.title||"Save"),i.call(this)}},value:{get:function(){return u.call(this)},set:function(t){this._value=t,c.call(this)}},createUrl:{get:function(){return this.getAttribute("create-url")||""},set:function(t){this.setAttribute("create-url",t)}},updateUrl:{get:function(){return this.getAttribute("update-url")||""},set:function(t){this.setAttribute("update-url",t)}},readonly:{get:function(){return"true"===this.getAttribute("readonly")},set:function(t){t?this.setAttribute("readonly",t):this.removeAttribute("readonly")}},title:{get:function(){return this.getAttribute("title")||""},set:function(t){this.setAttribute("title",t||"")}},description:{get:function(){return this.getAttribute("description")||""},set:function(t){this.setAttribute("description",t||"")}},buttons:{get:function(){return(this.getAttribute("buttons")||"").split(",").filter(Boolean)},set:function(t){this.setAttribute("buttons",t)}},persist:{get:function(){return"true"===this.getAttribute("persist")},set:function(t){this.setAttribute("persist",!0===t)}},disableValidation:{get:function(){return"true"===this.getAttribute("disable-validation")},set:function(t){this.setAttribute("disable-validation",!0===t)}},placeholderMaxLength:{get:function(){return parseInt(this.getAttribute("placeholder-maxlength")||"75")},set:function(t){this.setAttribute("placeholder-maxlength",t)}}});if(k.loadSchema=function(){var t=this,e=this.src;return fetch(e).then(function(t){return t.json()}).then(function(e){if(t.schema=e,t.onschemaloaded.call(t,e.title||"",e),t.persist&&sessionStorage[t.src]){var r=sessionStorage[t.src]||"";""!==r&&c.call(JSON.parse(r))}}).catch(function(t){throw t})},k.createdCallback=function(){var t=this;Array.prototype.slice.call(t.attributes).forEach(function(e){t.attributeChangedCallback(e.name,null,e.value)})},k.attributeChangedCallback=function(t,e,r){if(e!==r)switch(t){case"src":this.loadSchema();break;case"title":n.call(this);break;case"description":a.call(this);break;case"buttons":s.call(this)}},k.clearValidationErrors=function(){this.form.removeAttribute("data-error"),Array.prototype.slice.call(this.querySelectorAll("[data-error]")).forEach(function(t){t.removeAttribute("data-error")})},k.setInvalid=function(t,e){var r=this.querySelector('[name="'+t+'"]');r&&(r.setAttribute("data-valid","false"),r.parentNode.setAttribute("data-error",e))},k.setValid=function(t){var e=this.querySelector('[name="'+t+'"]');e&&(e.setAttribute("data-valid","true"),e.parentNode.removeAttribute("data-error"))},k.validateField=function(t,e){var r={};r[t]=e,this.isValid(r)},k.isValid=function(t){if(this.disableValidation)return!0;t=t||u.call(this);var r=this,i=this.schema,n=!0;return Object.keys(t).forEach(function(e){var a=r.querySelector('[name="'+e+'"]'),s=i.properties[e].pattern?a&&a.value||t[e]:t[e],u=p(i,e,s);u?(r.setInvalid(e,u),n=!1):r.setValid(e)}),this.persist&&e.sessionStorage&&(sessionStorage[this.src]=JSON.stringify(o.call(this))),n},k.oncreate=function(t,e){return!0},k.onupdate=function(t,e){return!0},k.onbuttonclick=function(t){return!0},k.onpopulatecomplete=function(){return!0},k.onschemaloaded=function(t,e){},!r.registerElement)throw new Error("document.registerElement does not exist. Are you missing the polyfill?");r.registerElement("pure-form",{prototype:k})}(HTMLElement.prototype,this,document);