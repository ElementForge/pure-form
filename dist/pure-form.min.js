/*!
 * pure-form - v1.0.0
 * JSON Schema driven Form written in pure JavaScript as a Web Component
 * https://github.com/john-doherty/pure-form
 * @author John Doherty <www.johndoherty.info>
 * @license MIT
 */
!function(t,e,i){"use strict";function r(){var t=this,i=this.src;C.get(i,"application/json",function(e){t.dispatchEvent(new CustomEvent("schema-errored",{detail:i,bubbles:!1}))},function(r){if(t.schema=JSON.parse(r),t.dispatchEvent(new CustomEvent("schema-loaded",{detail:i,bubbles:!1})),t.persist&&e.sessionStorage&&e.sessionStorage[t.src]){var n=e.sessionStorage[t.src]||"";""!==n&&m.call(JSON.parse(n))}})}function n(){if(this.schema){var t=this,e=this.schema.properties,i=v(this.schema),r=null;this.form=this.querySelector("form"),this.form||(this.form=f(null,"form",{action:"",method:"post",class:"pure-form-form",novalidate:"novalidate"}),""===this.getAttribute("create-url")&&""===this.getAttribute("update-url")||(this.form.onsubmit=function(t){t.preventDefault()}),this.form.addEventListener("focusout",function(e){var i=e.target;"submit"!==i.type&&t.validateOnBlur&&t.validateField(i.id,i.value)},!0)),this.form.innerHTML="",i=i.filter(function(t){return"links"!==t&&-1===t.indexOf("$")&&e.hasOwnProperty(t)});for(var n=0;n<i.length;n++){var a=i[n],s=e[a];r=f(null,"label",{for:a,class:"pure-form-label"}),s.format&&r.setAttribute("data-format",s.format),s.type&&r.setAttribute("data-type",s.type),s.required&&r.setAttribute("data-required",!0),f(r,"span",{class:"pure-form-label-text"},s.title||a);var o=h.call(this,a,s);if(!o)throw new Error("Failed to convert schema item to html element (key:"+a+")");var l="hidden"===o.type;this.readonly?(o.setAttribute("readonly","true"),"SELECT"===o.tagName&&o.setAttribute("disabled","true")):l||0===n&&o.setAttribute("autofocus","true"),l?this.form.appendChild(o):(r.appendChild(o),s.description&&s.description.length>this.placeholderMaxLength&&f(r,"span",{class:"pure-form-item-description"},s.description||""),this.form.appendChild(r)),this.appendChild(this.form)}u.call(this),t.dispatchEvent(new CustomEvent("render-complete",{bubbles:!1})),t.addEventListener("button-clicked",function(e){var i=e.detail,r=y((t.schema||{}).links,"title",i,!0)||y((t.schema||{}).links,"rel",i,!0);c.call(t,r)})}}function a(){if(""!==this.title){var t=f(null,"div",{class:"pure-form-title"},this.title);this.insertBefore(t,this.form)}else A(this,".pure-form-title")}function s(){if(""!==this.description){var t=f(null,"div",{class:"pure-form-description"},this.description);this.insertBefore(t,this.form)}else A(this,".pure-form-description")}function u(){var t=this;if(this.form&&""!==this.buttons){var e=this.buttons.split(","),i=f(this.form,"div",{class:"pure-form-buttons"});i.innerHTML="",e.forEach(function(t){f(i,"input",{type:"submit",value:t.trim(),class:"pure-form-button"})}),this.schema&&Array.isArray(this.schema.links)&&this.schema.links.forEach(function(t){f(i,"input",{type:"submit",value:(t.title||t.rel).trim(),class:"pure-form-button"})}),i.onclick=function(e){var i=e.target;"INPUT"===i.tagName&&"submit"===i.type&&t.dispatchEvent(new CustomEvent("button-clicked",{detail:i.value,bubbles:!0,cancelable:!0}))}}else A(this,".pure-form-buttons")}function o(){var t=(this.schema||{}).properties,e={};for(var i in t)if("links"!==i&&-1===i.indexOf("$")&&t.hasOwnProperty(i)){var r=t[i];if(t[i].readonly)e[i]=this.value&&this.value[i]||r.required&&r.default||void 0;else{var n=this.querySelector('[name="'+i+'"]');if(n)switch(r.type){case"array":"textarea"===r.items.format?e[i]=""!=n.value?n.value.split("\n"):[]:"uri"===r.items.format?e[i]=n.data:(Array.isArray(n.value),e[i]=n.value);break;case"boolean":e[i]=n.checked;break;case"integer":e[i]=n.value?parseInt(n.value):"";break;case"number":e[i]=n.value?parseFloat(n.value):"";break;default:e[i]=(n.value||"").trim()}r.required||""!==e[i]||delete e[i]}}return e}function l(){var t=this.schema.properties,e={};for(var i in t)if("links"!==i&&-1===i.indexOf("$")&&!t[i].readonly&&t.hasOwnProperty(i)){var r=t[i],n=this.querySelector('[name="'+i+'"]');if(n)switch(r.type){case"array":"uri"===r.items.format||"object"===r.items.type?e[i]=n.data:e[i]=n.value;break;case"boolean":e[i]=n.checked;break;default:e[i]=(n.value||"").trim()}}return e}function c(t){if(t){var e=this,r=o.call(this),n=t.href||i.location.href,a=(t.method||"POST").toLowerCase(),s=t.enctype||"application/json";e.clearValidationErrors(),e.isValid(r)&&C[a](n,s,r,function(t){e.dispatchEvent(new CustomEvent("submit-failed",{detail:n,bubbles:!1}))},function(t){e.dispatchEvent(new CustomEvent("submit-successful",{detail:t,bubbles:!1}))})}}function m(t){t=t||this._value;var e=this;Object.keys(t).forEach(function(i){if("links"!==i){var r=e.querySelector('[name="'+i+'"]'),n=void 0!==t[i]?t[i]:"";r&&g(r,n)}}),e.dispatchEvent(new CustomEvent("value-set",{bubbles:!1}))}function h(t,e){var i=null,r=e.items&&e.items.type||e.type,n=(e.items&&e.items.format||e.format||"").toLowerCase();switch(r){case"number":case"integer":if(Number.isInteger(e.minimum)&&Number.isInteger(e.maximum)){f(i=f(null,"select",{name:t,id:t}),"option",{value:""});for(var a=e.minimum;a<=e.maximum;a++)f(i,"option",{value:a},a)}else i=f(null,"input",{name:t,id:t,type:"number",value:""});break;default:if(Array.isArray(e.enum))f(i=f(null,"select",{name:t,id:t}),"option",{value:""}),e.enum.forEach(function(t){f(i,"option",{value:t},t)});else switch(n.toLowerCase()){case"url":case"uri":i=f(null,"input",{name:t,id:t,type:"url",value:""});break;case"textarea":i=f(null,"textarea",{name:t,id:t,value:"",rows:3});break;case"date":i=f(null,"input",{name:t,id:t,type:"date",value:""});break;case"email":i=f(null,"input",{name:t,id:t,type:"email",pattern:x.email,value:""});break;default:i=f(null,"input",{name:t,id:t,type:"text",value:""})}}return i&&(i.setAttribute("autocomplete","off"),e.readonly&&i.setAttribute("readonly","true"),e.readonly&&"SELECT"===i.tagName&&i.setAttribute("disabled","true"),e.required&&i.setAttribute("required","required"),e.pattern&&i.setAttribute("pattern",e.pattern),e.min&&i.setAttribute("min",e.min),e.max&&i.setAttribute("max",e.max),e.minLength&&i.setAttribute("minlength",e.minLength),e.maxLength&&i.setAttribute("maxlength",e.maxLength),e.minItems&&i.setAttribute("min-items",e.minItems),e.maxItems&&i.setAttribute("max-items",e.maxItems),e.description&&e.description.length<this.placeholderMaxLength&&i.setAttribute("placeholder",e.description||"")),i}function f(t,e,r,n,a){var s=i.createElement(e),u=e.indexOf("-")>0;if(r)for(var o in r)"class"===o?s.className=r[o]:"id"===o?s.id=r[o]:"name"===o?s.setAttribute(o,r[o]):u||o in s?s[o]=r[o]:s.setAttribute(o,r[o]);return void 0!==n&&s.appendChild(i.createTextNode(n)),void 0!==a&&(s.innerHTML="",d(a,s)),t&&t.appendChild(s),s}function d(t,e){e=e||i.createDocumentFragment();var r=null,n=i.createElement("div");n.innerHTML=t;for(var a=n.getElementsByTagName("script"),s=a.length-1;s>=0;s--)a[s].parentElement.removeChild(a[s]);for(;r=n.firstChild;)e.appendChild(r);return e}function p(t,e,i){var r=b(t,e,!0),n=(i+"").length;if(r){if(i&&"string"===r.type&&"email"===r.format&&!E(i.toString(),x.email))return"Invalid email address";if(r.required&&(!i||Array.isArray(i)&&i.length<=0))return"This field must have a value";if(r.minItems&&Array.isArray(i)&&i.length<r.minItems)return"Please select at least "+r.minItems+" item(s)";if(r.maxItems&&Array.isArray(i)&&i.length>r.maxItems)return"Please select a maximum of "+r.maxItems+" item(s)";if(i&&r.pattern&&!E(i.toString(),r.pattern))return"The value is not in the expected format";if(i&&r.minimum&&parseInt(i,10)<r.minimum)return"The value must not be lower than "+r.minimum;if(i&&r.maximum&&parseInt(i,10)>r.maximum)return"The value must not be higher than "+r.maximum;if(i&&r.minLength&&n<r.minLength)return"The value must have a minimum of "+r.minLength+" character(s)"}return null}function b(t,e,i){if(void 0===t)return!1;(i=void 0!==t.$schema||i)&&(t.properties&&e.indexOf(".properties")<=-1?e="properties."+e:t.items&&e.indexOf(".items")<=-1&&(e="items."+e));var r=e.indexOf(".");return r>-1?(t=t[e.substring(0,r)],e=e.substr(r+1),b(t,e,i)):t[e]}function v(t){t=t.properties||t;var e=Object.keys(t);return e.sort(function(e,i){return(t[e].id?parseInt(t[e].id.replace(/[^0-9]+/gi,"")||"0",10):0)-(t[i].id?parseInt(t[i].id.replace(/[^0-9]+/gi,"")||"0",10):0)}),e}function g(t,e){var i=t?t.tagName.toLowerCase():"",r=t.type||"";switch(i){case"input":"checkbox"===r?e?t.setAttribute("checked",!0===e):t.removeAttribute("checked"):t.value=e;break;case"textarea":t.value=e.join?e.join("\n"):e;break;default:t.value=e}}function y(t,e,i,r){for(var n=[],a=0,s=(t=t||[]).length;a<s;a++)if(t[a][e]===i){if(r)return t[a];n.push(t[a])}return r?null:n}function A(t,e){var r=(t||i).querySelector(e);r&&r.parentElement.removeChild(r)}function E(t,e){return(e.constructor!==RegExp?new RegExp(e,"g"):e).test(t)}var x={email:"^[a-zA-Z0-9.-_]{1,}@[a-zA-Z.-]{2,}[.]{1}[a-zA-Z]{2,}$"},k=Object.create(t,{src:{get:function(){return this.getAttribute("src")||""},set:function(t){this.setAttribute("src",t)}},schema:{get:function(){return this._schema||null},set:function(t){this._schema=t,this.title=this._schema.title,this.description=this._schema.description;var e=y(this._schema.links,"rel","self",!0);e&&(this.updateUrl=e.href);var i=y(this._schema.links,"rel","create",!0);i&&(this.createUrl=i.href),n.call(this)}},value:{get:function(){return o.call(this)},set:function(t){this._value=t,m.call(this)}},createUrl:{get:function(){return this.getAttribute("create-url")||""},set:function(t){this.setAttribute("create-url",t)}},updateUrl:{get:function(){return this.getAttribute("update-url")||""},set:function(t){this.setAttribute("update-url",t)}},readonly:{get:function(){return"true"===this.getAttribute("readonly")},set:function(t){t?this.setAttribute("readonly",t):this.removeAttribute("readonly")}},title:{get:function(){return this.getAttribute("title")||""},set:function(t){this.setAttribute("title",t||"")}},description:{get:function(){return this.getAttribute("description")||""},set:function(t){this.setAttribute("description",t||"")}},buttons:{get:function(){return this.getAttribute("buttons")||""},set:function(t){t=t.split(",").filter(Boolean).join(","),this.setAttribute("buttons",t)}},persist:{get:function(){return"true"===this.getAttribute("persist")},set:function(t){this.setAttribute("persist",!0===t)}},disableValidation:{get:function(){return"true"===this.getAttribute("disable-validation")},set:function(t){this.setAttribute("disable-validation",!0===t)}},placeholderMaxLength:{get:function(){return parseInt(this.getAttribute("placeholder-maxlength")||"75",10)},set:function(t){this.setAttribute("placeholder-maxlength",t)}},autofocusError:{get:function(){return"true"===this.getAttribute("autofocus-error")},set:function(t){this.setAttribute("autofocus-error",!0===t)}},validateOnBlur:{get:function(){return"true"===this.getAttribute("validate-onblur")},set:function(t){this.setAttribute("validate-onblur",!0===t),t&&(this.autofocusError=!1)}}});k.createdCallback=function(){var t=this;Array.prototype.slice.call(t.attributes).forEach(function(e){t.attributeChangedCallback(e.name,null,e.value)})},k.attributeChangedCallback=function(t,e,i){if(e!==i)switch(t){case"src":r.call(this);break;case"title":a.call(this);break;case"description":s.call(this);break;case"buttons":u.call(this)}},k.clearValidationErrors=function(){this.form.removeAttribute("data-error"),Array.prototype.slice.call(this.querySelectorAll("[data-error]")).forEach(function(t){t.removeAttribute("data-error")})},k.setInvalid=function(t,e){var i=this.querySelector('[name="'+t+'"]');i&&(i.setAttribute("data-valid","false"),i.parentNode.setAttribute("data-error",e))},k.setValid=function(t){var e=this.querySelector('[name="'+t+'"]');e&&(e.setAttribute("data-valid","true"),e.parentNode.removeAttribute("data-error"))},k.validateField=function(t,e){var i={};return i[t]=e,this.isValid(i)},k.isValid=function(t){if(this.disableValidation)return!0;t=t||o.call(this);var i=this,r=this.schema,n=!0;if(Object.keys(t).forEach(function(e){var a=i.querySelector('[name="'+e+'"]'),s=r.properties[e].pattern?a&&a.value||t[e]:t[e],u=p(r,e,s);u?(i.setInvalid(e,u),n=!1):i.setValid(e)}),this.persist&&e.sessionStorage&&(e.sessionStorage[this.src]=JSON.stringify(l.call(this))),this.autofocusError){var a=this.querySelector('form [data-valid="false"]');a&&a.focus()}return n},"initCustomEvent"in i.createEvent("CustomEvent")&&(e.CustomEvent=function(t,e){e=e||{bubbles:!1,cancelable:!1,detail:void 0};var r=i.createEvent("CustomEvent");return r.initCustomEvent(t,e.bubbles,e.cancelable,e.detail),r},e.CustomEvent.prototype=e.Event.prototype);var C=function(){function t(){try{return new XMLHttpRequest}catch(t){try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(t){return console&&console.log("pure-form: XMLHttpRequest not supported"),null}}}function e(t){return Object.keys(t||{}).map(function(e){return encodeURI(e+"="+t[e])}).join("&")}function i(i,r,n,a,s,u){var o=t();if(o="withCredentials"in o?o:new XDomainRequest){if(i=i||"GET",n=n||"application/json",o.open(i,r),o.withCredentials=!0,o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.setRequestHeader("Content-Type",n),o.onreadystatechange=function(){4===o.readyState&&200===o.status?u(o.responseText):s(o.status)},a)switch(n){case"application/x-www-form-urlencoded":a=e(a);break;default:a=JSON.stringify(a)}o.send(a||null)}}return{get:function(t,e,r,n){i("GET",t,e,null,r,n)},post:function(t,e,r,n,a){i("POST",t,e,r,n,a)},put:function(t,e,r,n,a){i("PUT",t,e,r,n,a)},patch:function(t,e,r,n){i("PATCH",t,e,r,n)},delete:function(t,e,r,n){i("DELETE",t,e,r,n)}}}();if(!i.registerElement)throw new Error("document.registerElement does not exist. Are you missing the polyfill?");i.registerElement("pure-form",{prototype:k})}(HTMLElement.prototype,this,document);